<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Eco-Price Estimator</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #22c55e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); max-width: 800px; margin: 40px auto; padding: 20px; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 20px; }
        h1, h2 { margin-top: 0; color: var(--primary); }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; }
        #result { margin-top: 24px; padding: 16px; border-radius: 8px; background: #f0f9ff; display: none; }
        .price { font-size: 24px; font-weight: bold; color: var(--primary); }
        
        /* Dashboard Styles */
        .dashboard { display: none; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; }
        .status-badge { padding: 4px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; }
        .drift-warning { background: #fee2e2; color: var(--danger); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <div class='card'>
        <h1>🚗 Eco-Price Estimator</h1>
        <p>Gebrauchtwagen-Preisvorhersage (Deployment Projekt 1)</p>
        
        <form id='price-form'>
            <div class='form-group'>
                <label>Marke</label>
                <select id='brand'>
                    <option value='Toyota'>Toyota</option>
                    <option value='VW'>VW</option>
                    <option value='BMW'>BMW</option>
                    <option value='Audi'>Audi</option>
                    <option value='Tesla'>Tesla</option>
                </select>
            </div>
            <div style='display: flex; gap: 10px;'>
                <div class='form-group' style='flex: 1;'>
                    <label>Baujahr</label>
                    <input type='number' id='year' value='2020'>
                </div>
                <div class='form-group' style='flex: 1;'>
                    <label>Kilometer</label>
                    <input type='number' id='mileage' value='50000'>
                </div>
            </div>
            <div class='form-group'>
                <label>Kraftstoff</label>
                <select id='fuel_type'>
                    <option value='Gasoline'>Benzin</option>
                    <option value='Diesel'>Diesel</option>
                    <option value='Electric'>Elektro</option>
                    <option value='Hybrid'>Hybrid</option>
                </select>
            </div>
            <button type='submit' id='btn-predict'>Preis schätzen</button>
        </form>

        <div id='result'>
            <div class='price' id='predicted-price'>€ 0.00</div>
            <p id='info' style='font-size: 14px; color: #64748b;'></p>
        </div>
    </div>

    <div style='text-align: center; margin-bottom: 10px;'>
        <button onclick='toggleDashboard()' style='background: #64748b; width: auto; font-size: 13px; padding: 6px 16px;'>Admin Dashboard</button>
    </div>

    <div id='dashboard' class='card dashboard'>
        <h2>📊 Model Monitoring</h2>
        <div id='drift-alert' class='drift-warning'>⚠️ DATA DRIFT DETECTED: Hohe Anzahl an Outliers!</div>
        <div style='display: flex; gap: 20px; margin-bottom: 15px;'>
            <div>Requests: <b id='stat-total'>0</b></div>
            <div>Outliers: <b id='stat-outliers' style='color: var(--danger)'>0</b></div>
        </div>
        <table>
            <thead>
                <tr><th>Zeit</th><th>Auto</th><th>Preis</th><th>Status</th></tr>
            </thead>
            <tbody id='log-table'></tbody>
        </table>
    </div>

    <script>
        const form = document.getElementById('price-form');
        
        form.onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                brand: document.getElementById('brand').value,
                year: parseInt(document.getElementById('year').value),
                mileage: parseFloat(document.getElementById('mileage').value),
                fuel_type: document.getElementById('fuel_type').value
            };

            const res = await fetch('/predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            document.getElementById('predicted-price').textContent = `€ ${data.predicted_price.toLocaleString()}`;
            document.getElementById('info').textContent = data.confidence_score < 0.9 ? '⚠️ Warnung: Ungewöhnliche Daten.' : 'Basierend auf aktuellen Marktdaten.';
            document.getElementById('result').style.display = 'block';
            
            if (document.getElementById('dashboard').style.display === 'block') updateDashboard();
        };

        async function updateDashboard() {
            const res = await fetch('/monitoring');
            const data = await res.json();
            
            document.getElementById('stat-total').textContent = data.total_requests;
            document.getElementById('stat-outliers').textContent = data.outlier_count;
            document.getElementById('drift-alert').style.display = data.drift_detected ? 'block' : 'none';
            
            const tbody = document.getElementById('log-table');
            tbody.innerHTML = data.logs.reverse().map(log => `
                <tr>
                    <td>${log.ts.split('T')[1].split('.')[0]}</td>
                    <td>${log.request.brand} (${log.request.year})</td>
                    <td>€${log.price}</td>
                    <td><span class='status-badge' style='background: ${log.is_outlier ? '#fee2e2' : '#dcfce7'}; color: ${log.is_outlier ? '#ef4444' : '#166534'}'>
                        ${log.is_outlier ? 'OUTLIER' : 'OK'}
                    </span></td>
                </tr>
            `).join('');
        }

        function toggleDashboard() {
            const db = document.getElementById('dashboard');
            db.style.display = db.style.display === 'block' ? 'none' : 'block';
            if (db.style.display === 'block') updateDashboard();
        }
    </script>
</body>
</html>
